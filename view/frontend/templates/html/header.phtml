<?php
/**
 * @var $block \CravenDunnill\Header\Block\Html\Header
 */
?>
<div class="cd-header-container">
	<!-- Desktop Header -->
	<div class="cd-header-desktop">
		<div class="cd-header-left">
			<a href="#" class="cd-search-button" id="cd-search-button">
				<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="11" cy="11" r="8"></circle>
					<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
				</svg>
				<span>Search</span>
			</a>
		</div>
		
		<div class="cd-header-center">
			<a class="cd-logo" href="<?= $block->getBaseUrl() ?>">
				<img src="<?= $block->getViewFileUrl('CravenDunnill_Header::images/logo.svg') ?>" alt="Craven Dunnill" height="30">
				<div class="cd-tagline">SINCE 1872</div>
			</a>
		</div>
		
		<div class="cd-header-right">
			<a class="cd-header-icon" href="<?= $block->getWishlistUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
				</svg>
				<span>Your Project</span>
			</a>
			
			<a class="cd-header-icon" href="<?= $block->getAccountUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
					<circle cx="12" cy="7" r="4"></circle>
				</svg>
				<span>Account</span>
			</a>
			
			<!-- Minicart Trigger -->
			<div class="cd-header-icon cd-minicart-trigger" data-block="minicart" data-role="dropdownDialog-toggle">
				<a class="action showcart" href="#" data-bind="scope: 'minicart_content'">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="9" cy="21" r="1"></circle>
						<circle cx="20" cy="21" r="1"></circle>
						<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					</svg>
					<span class="counter qty" data-bind="css: { empty: !!getCartParam('summary_count') == false }, blockLoader: isLoading">
						<span class="counter-number"><!-- ko text: getCartParam('summary_count') --><!-- /ko --></span>
					</span>
					<span>Trolley</span>
				</a>
			</div>
		</div>
	</div>

	<!-- Mobile Header -->
	<div class="cd-header-mobile">
		<div class="cd-header-mobile-left">
			<div class="cd-menu-button" id="cd-menu-button">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="3" y1="12" x2="21" y2="12"></line>
					<line x1="3" y1="6" x2="21" y2="6"></line>
					<line x1="3" y1="18" x2="21" y2="18"></line>
				</svg>
			</div>
			
			<!-- Search button moved here -->
			<a href="#" class="cd-search-button-mobile" id="cd-search-button-mobile">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="11" cy="11" r="8"></circle>
					<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
				</svg>
			</a>
			
			<a class="cd-logo-mobile" href="<?= $block->getBaseUrl() ?>">
				<img src="<?= $block->getViewFileUrl('CravenDunnill_Header::images/logo.svg') ?>" alt="Craven Dunnill" height="30">
			</a>
		</div>
		
		<div class="cd-header-mobile-right">
			<a class="cd-header-icon-mobile" href="<?= $block->getWishlistUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
				</svg>
			</a>
			
			<a class="cd-header-icon-mobile" href="<?= $block->getAccountUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
					<circle cx="12" cy="7" r="4"></circle>
				</svg>
			</a>
			
			<!-- Mobile Minicart Trigger -->
			<div class="cd-header-icon-mobile cd-minicart-trigger-mobile" data-block="minicart" data-role="dropdownDialog-toggle">
				<a class="action showcart" href="#" data-bind="scope: 'minicart_content'">
					<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="9" cy="21" r="1"></circle>
						<circle cx="20" cy="21" r="1"></circle>
						<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					</svg>
					<span class="counter qty" data-bind="css: { empty: !!getCartParam('summary_count') == false }, blockLoader: isLoading">
						<span class="counter-number"><!-- ko text: getCartParam('summary_count') --><!-- /ko --></span>
					</span>
				</a>
			</div>
		</div>
	</div>
	
	<!-- Search Panel -->
	<div class="cd-search-panel" id="cd-search-panel" style="display: none;">
		<div class="cd-search-panel-inner">
			<form class="cd-search-form" action="<?= $block->getSearchUrl() ?>" method="get">
				<div class="cd-search-input-wrapper">
					<input type="text" name="q" id="cd-search-input" class="cd-search-input" placeholder="Search products..." autocomplete="off">
					<button type="submit" class="cd-search-submit">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="11" cy="11" r="8"></circle>
							<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
						</svg>
					</button>
				</div>
				<button type="button" class="cd-search-close" id="cd-search-close">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</button>
			</form>
		</div>
	</div>
	
	<!-- Mobile Menu Slide-out -->
	<div class="cd-mobile-menu" id="cd-mobile-menu">
		<div class="cd-mobile-menu-header">
			<h3>Shop Craven Dunnill</h3>
			<button type="button" class="cd-mobile-menu-close" id="cd-mobile-menu-close">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</button>
		</div>
		<div class="cd-mobile-menu-content">
			<nav class="cd-mobile-nav">
				<ul class="cd-mobile-nav-list">
					<li class="cd-mobile-nav-item">
						<a href="<?= $block->getBaseUrl() ?>" class="cd-mobile-nav-link">Home</a>
					</li>
					
					<?php
					// Get category structure
					$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
					$categoryHelper = $objectManager->get('\Magento\Catalog\Helper\Category');
					$categoryFactory = $objectManager->get('\Magento\Catalog\Model\CategoryFactory');
					$storeManager = $objectManager->get('\Magento\Store\Model\StoreManagerInterface');
					
					// Get store ID
					$storeId = $storeManager->getStore()->getId();
					
					// Get root category ID
					$rootCategoryId = $storeManager->getStore($storeId)->getRootCategoryId();
					
					// Get category object
					$rootCategory = $categoryFactory->create()->load($rootCategoryId);
					
					// Get all categories under root
					$topCategories = $rootCategory->getChildrenCategories();
					
					// Output categories
					foreach ($topCategories as $category):
						if (!$category->getIsActive()) continue; // Skip inactive categories
					?>
						<li class="cd-mobile-nav-item has-children">
							<a href="<?= $categoryHelper->getCategoryUrl($category) ?>" class="cd-mobile-nav-link">
								<?= $category->getName() ?>
							</a>
							<?php
							// Check for subcategories
							$subcategories = $category->getChildrenCategories();
							if (count($subcategories)): 
							?>
								<span class="cd-mobile-nav-toggle">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<polyline points="6 9 12 15 18 9"></polyline>
									</svg>
								</span>
								<ul class="cd-mobile-nav-sublist">
									<?php foreach ($subcategories as $subcategory):
										if (!$subcategory->getIsActive()) continue; // Skip inactive subcategories 
									?>
										<li class="cd-mobile-nav-subitem">
											<a href="<?= $categoryHelper->getCategoryUrl($subcategory) ?>" class="cd-mobile-nav-sublink">
												<?= $subcategory->getName() ?>
											</a>
										</li>
									<?php endforeach; ?>
								</ul>
							<?php endif; ?>
						</li>
					<?php endforeach; ?>
					
					<li class="cd-mobile-nav-item">
						<a href="/delivery/" class="cd-mobile-nav-link">Delivery</a>
					</li>
					<li class="cd-mobile-nav-item">
						<a href="/contact/" class="cd-mobile-nav-link">Contact</a>
					</li>
				</ul>
			</nav>
		</div>
		<!-- Mobile account footer with button styling -->
		<div class="cd-mobile-account-footer">
			<a href="<?= $block->getAccountUrl() ?>" class="cd-mobile-account-link">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
					<circle cx="12" cy="7" r="4"></circle>
				</svg>
				ACCOUNT
			</a>
			<a href="<?= $block->getWishlistUrl() ?>" class="cd-mobile-account-link">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
				</svg>
				YOUR PROJECT
			</a>
		</div>
	</div>
	
	<!-- Simple Overlay -->
	<div class="cd-overlay" id="cd-overlay"></div>
	
	<script>
	require(['jquery'], function($) {
		'use strict';
		
		$(document).ready(function() {
			// Function to prevent body scroll
			function preventBodyScroll() {
				var scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
				window.lastScrollPosition = scrollPosition;
				document.documentElement.classList.add('scroll-locked');
				document.body.classList.add('scroll-locked');
				document.body.style.setProperty('top', `-${scrollPosition}px`, 'important');
			}

			// Function to allow body scroll
			function allowBodyScroll() {
				document.documentElement.classList.remove('scroll-locked');
				document.body.classList.remove('scroll-locked');
				document.body.style.removeProperty('overflow');
				document.body.style.removeProperty('position');
				document.body.style.removeProperty('height');
				document.body.style.removeProperty('width');
				document.body.style.removeProperty('top');
				const scrollPosition = window.lastScrollPosition || 0;
				window.scrollTo(0, scrollPosition);
			}
			
			// Mobile menu toggle button
			$('#cd-menu-button').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				
				console.log('Mobile menu button clicked');
				
				// Show mobile menu
				$('#cd-mobile-menu').addClass('active');
				
				// Show overlay
				$('#cd-overlay').css('display', 'block');
				
				// Apply blur effect to content
				$('.page-main, .page-footer, .nav-sections, .breadcrumbs').css('filter', 'blur(4px)');
				
				// Prevent body scrolling
				preventBodyScroll();
			});
			
			// Mobile menu close button
			$('#cd-mobile-menu-close').on('click', function(e) {
				e.preventDefault();
				
				// Hide mobile menu
				$('#cd-mobile-menu').removeClass('active');
				
				// Hide overlay
				$('#cd-overlay').css('display', 'none');
				
				// Remove blur effect
				$('.page-main, .page-footer, .nav-sections, .breadcrumbs').css('filter', 'none');
				
				// Allow body scroll
				allowBodyScroll();
			});
			
			// Mobile submenu toggle
			$('.cd-mobile-nav-toggle').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				
				var $this = $(this);
				var $sublist = $this.siblings('.cd-mobile-nav-sublist');
				
				// Toggle active class for arrow rotation
				$this.toggleClass('active');
				
				// Toggle submenu visibility
				$sublist.toggleClass('active');
				
				// Prevent event bubbling to parent elements
				return false;
			});
			
			// Search button functionality
			$('#cd-search-button, #cd-search-button-mobile').on('click', function(e) {
				e.preventDefault();
				console.log('Search button clicked');
				
				// Now, safely display the search panel
				$('#cd-search-panel').css('display', 'block');
				
				// Show overlay
				$('#cd-overlay').css('display', 'block');
				
				// Apply blur only to main content
				$('.page-main, .page-footer, .nav-sections, .breadcrumbs').css('filter', 'blur(4px)');
				
				// Force header elements to be visible
				$('.page-header, header.page-header, .cd-header-container').css({
					'position': 'relative',
					'z-index': '1200',
					'filter': 'none',
					'opacity': '1',
					'visibility': 'visible'
				});
				
				// Focus search input
				setTimeout(function() {
					$('#cd-search-input').focus();
				}, 100);
			});
			
			// Search close button
			$('#cd-search-close').on('click', function(e) {
				e.preventDefault();
				
				$('#cd-search-panel').hide();
				$('#cd-overlay').hide();
				$('.page-main, .page-footer, .nav-sections, .breadcrumbs').css('filter', 'none');
			});
			
			// Overlay click
			$('#cd-overlay').on('click', function() {
				console.log('Overlay clicked');
				
				// Hide search panel
				$('#cd-search-panel').hide();
				
				// Hide mobile menu
				$('#cd-mobile-menu').removeClass('active');
				
				// Hide overlay
				$(this).css('display', 'none');
				
				// Remove blur effect
				$('.page-main, .page-footer, .nav-sections, .breadcrumbs').css('filter', 'none');
				
				// Allow body scroll
				allowBodyScroll();
			});
			
			// Escape key handler
			$(document).keyup(function(e) {
				if (e.key === "Escape") {
					$('#cd-search-panel').hide();
					$('#cd-mobile-menu').removeClass('active');
					$('#cd-overlay').hide();
					$('.page-main, .page-footer, .nav-sections, .breadcrumbs').css('filter', 'none');
					allowBodyScroll();
				}
			});
		});
	});
	</script>
</div>

<!-- Initialize minicart -->
<script type="text/x-magento-init">
{
	"[data-block='minicart']": {
		"Magento_Ui/js/core/app": <?= /* @noEscape */ $block->getJsLayout() ?>
	}
}
</script>