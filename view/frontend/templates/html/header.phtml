<?php
/**
 * @var $block \CravenDunnill\Header\Block\Html\Header
 */
?>
<div class="cd-header-container">
	<!-- Desktop Header -->
	<div class="cd-header-desktop">
		<div class="cd-header-left">
			<a href="#" class="cd-search-button" id="cd-search-button">
				<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="11" cy="11" r="8"></circle>
					<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
				</svg>
				<span>Search</span>
			</a>
		</div>
		
		<div class="cd-header-center">
			<a class="cd-logo" href="<?= $block->getBaseUrl() ?>">
				<img src="<?= $block->getViewFileUrl('CravenDunnill_Header::images/logo.svg') ?>" alt="Craven Dunnill" height="30">
				<div class="cd-tagline">SINCE 1872</div>
			</a>
		</div>
		
		<div class="cd-header-right">
			<a class="cd-header-icon" href="<?= $block->getWishlistUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
				</svg>
				<span>Your Project</span>
			</a>
			
			<a class="cd-header-icon" href="<?= $block->getAccountUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
					<circle cx="12" cy="7" r="4"></circle>
				</svg>
				<span>Account</span>
			</a>
			
			<div class="cd-header-icon cd-cart-trigger" id="cd-cart-trigger">
				<div class="cd-cart-icon-wrapper">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="9" cy="21" r="1"></circle>
						<circle cx="20" cy="21" r="1"></circle>
						<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					</svg>
					<?php if ($block->getCartItemCount() > 0): ?>
						<span class="cd-cart-counter"></span>
					<?php endif; ?>
				</div>
				<span>Trolley</span>
			</div>
		</div>
	</div>

	<!-- Mobile Header -->
	<div class="cd-header-mobile">
		<div class="cd-header-mobile-left">
			<div class="cd-menu-button" id="cd-menu-button">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="3" y1="12" x2="21" y2="12"></line>
					<line x1="3" y1="6" x2="21" y2="6"></line>
					<line x1="3" y1="18" x2="21" y2="18"></line>
				</svg>
			</div>
			<a class="cd-logo-mobile" href="<?= $block->getBaseUrl() ?>">
				<img src="<?= $block->getViewFileUrl('CravenDunnill_Header::images/logo.svg') ?>" alt="Craven Dunnill" height="30">
			</a>
		</div>
		
		<div class="cd-header-mobile-center">
			<a href="#" class="cd-search-button-mobile" id="cd-search-button-mobile">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="11" cy="11" r="8"></circle>
					<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
				</svg>
			</a>
		</div>
		
		<div class="cd-header-mobile-right">
			<a class="cd-header-icon-mobile" href="<?= $block->getWishlistUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
				</svg>
			</a>
			
			<a class="cd-header-icon-mobile" href="<?= $block->getAccountUrl() ?>">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
					<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
					<circle cx="12" cy="7" r="4"></circle>
				</svg>
			</a>
			
			<div class="cd-header-icon-mobile cd-cart-trigger" id="cd-cart-trigger-mobile">
				<div class="cd-cart-icon-wrapper">
					<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="9" cy="21" r="1"></circle>
						<circle cx="20" cy="21" r="1"></circle>
						<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					</svg>
					<?php if ($block->getCartItemCount() > 0): ?>
						<span class="cd-cart-counter"></span>
					<?php endif; ?>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Search Panel -->
	<div class="cd-search-panel" id="cd-search-panel" style="display: none;">
		<div class="cd-search-panel-inner">
			<form class="cd-search-form" action="<?= $block->getSearchUrl() ?>" method="get">
				<div class="cd-search-input-wrapper">
					<input type="text" name="q" id="cd-search-input" class="cd-search-input" placeholder="Search products..." autocomplete="off">
					<button type="submit" class="cd-search-submit">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="11" cy="11" r="8"></circle>
							<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
						</svg>
					</button>
				</div>
				<button type="button" class="cd-search-close" id="cd-search-close">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</button>
			</form>
		</div>
	</div>
	
	<!-- Mini Cart -->
	<div class="cd-minicart" id="cd-minicart">
		<div class="cd-minicart-header">
			<h3>Your Trolley</h3>
			<button type="button" class="cd-minicart-close" id="cd-minicart-close">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#122C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</button>
		</div>
		<div class="cd-minicart-content" data-mage-init='{"Magento_Ui/js/core/app": <?= /* @noEscape */ $block->getJsLayout() ?>}'>
			<!-- Minicart content will be dynamically loaded here -->
			<div id="minicart-content-wrapper"></div>
		</div>
	</div>
	
	<!-- Overlay -->
	<div class="cd-overlay" id="cd-overlay"></div>

	
	<script>
		// IMPORTANT: This script moves the overlay to prevent it from covering the header
		(function() {
			// Function to reposition the overlay so it doesn't cover header
			function fixOverlayPosition() {
				var overlay = document.getElementById('cd-overlay');
				var pageMain = document.querySelector('.page-main');
				
				if (overlay && pageMain) {
					// Only move if not already positioned correctly
					if (overlay.parentNode !== pageMain) {
						// Clone the overlay to preserve event handlers
						var newOverlay = overlay.cloneNode(true);
						
						// Remove the original
						overlay.parentNode.removeChild(overlay);
						
						// Add the clone to page-main
						pageMain.insertBefore(newOverlay, pageMain.firstChild);
						
						// Fix positioning
						newOverlay.style.position = 'absolute';
						newOverlay.style.top = '0';
						newOverlay.style.left = '0';
						newOverlay.style.right = '0';
						newOverlay.style.bottom = '0';
						newOverlay.style.zIndex = '100';
						
						// Reattach event listeners if needed
						newOverlay.addEventListener('click', function() {
							document.getElementById('cd-search-panel').style.display = 'none';
							newOverlay.style.display = 'none';
							
							// Remove blur from all elements
							document.querySelectorAll('.page-main, .page-footer, .nav-sections, .breadcrumbs').forEach(function(el) {
								if (el) el.style.filter = 'none';
							});
						});
					}
				}
				
				// Ensure header elements have the highest z-index
				var headerElements = [
					'.page-header',
					'header.page-header',
					'.cd-header-container',
					'.cd-header-desktop',
					'.cd-header-mobile',
					'.cd-header-left',
					'.cd-header-right',
					'.cd-header-center'
				];
				
				headerElements.forEach(function(selector) {
					document.querySelectorAll(selector).forEach(function(el) {
						if (el) {
							el.style.position = 'relative';
							el.style.zIndex = '1200';
							el.style.filter = 'none';
							el.style.opacity = '1';
							el.style.visibility = 'visible';
						}
					});
				});
			}
			
			// Run immediately
			fixOverlayPosition();
			
			// Also run when DOM is ready
			document.addEventListener('DOMContentLoaded', function() {
				console.log('Header overlay fix loaded');
				fixOverlayPosition();
				
				// Enhanced close button functionality
				var searchCloseButton = document.getElementById('cd-search-close');
				if (searchCloseButton) {
					// Remove any existing handlers
					var newSearchCloseButton = searchCloseButton.cloneNode(true);
					searchCloseButton.parentNode.replaceChild(newSearchCloseButton, searchCloseButton);
					
					// Add new, more direct handler
					newSearchCloseButton.addEventListener('click', function(e) {
						e.preventDefault();
						e.stopPropagation();
						console.log('Search close button clicked - enhanced inline handler');
						
						// Hide search panel
						var searchPanel = document.getElementById('cd-search-panel');
						if (searchPanel) searchPanel.style.display = 'none';
						
						// Find and hide overlay (handle both relocated and original positions)
						var pageMainOverlay = document.querySelector('.page-main #cd-overlay');
						if (pageMainOverlay) pageMainOverlay.style.display = 'none';
						
						var originalOverlay = document.querySelector('#cd-overlay:not(.page-main #cd-overlay)');
						if (originalOverlay) originalOverlay.style.display = 'none';
						
						// Remove blur from content
						document.querySelectorAll('.page-main, .page-footer, .nav-sections, .breadcrumbs').forEach(function(el) {
							if (el) el.style.filter = 'none';
						});
						
						return false;
					});
				}
				
				// Run again when search button is clicked
				document.getElementById('cd-search-button').addEventListener('click', function(e) {
					e.preventDefault();
					console.log('Search button clicked - fixing overlay position');
					
					// Ensure overlay is properly positioned
					fixOverlayPosition();
					
					// Now, safely display the search panel
					document.getElementById('cd-search-panel').style.display = 'block';
					
					// Get the repositioned overlay
					var overlay = document.querySelector('.page-main #cd-overlay');
					if (overlay) {
						overlay.style.display = 'block';
					}
					
					// Apply blur only to main content
					document.querySelectorAll('.page-main, .page-footer, .nav-sections, .breadcrumbs').forEach(function(el) {
						if (el) el.style.filter = 'blur(4px)';
					});
					
					// Force header elements to be visible
					document.querySelectorAll('.page-header, header.page-header, .cd-header-container').forEach(function(el) {
						if (el) {
							el.style.position = 'relative';
							el.style.zIndex = '1200';
							el.style.filter = 'none';
							el.style.opacity = '1';
							el.style.visibility = 'visible';
						}
					});
					
					// Focus search input
					setTimeout(function() {
						document.getElementById('cd-search-input').focus();
					}, 100);
				});
				
				// Also add handler for mobile search button
				if (document.getElementById('cd-search-button-mobile')) {
					document.getElementById('cd-search-button-mobile').addEventListener('click', function(e) {
						e.preventDefault();
						console.log('Mobile search button clicked - fixing overlay position');
						
						// Ensure overlay is properly positioned
						fixOverlayPosition();
						
						// Now, safely display the search panel
						document.getElementById('cd-search-panel').style.display = 'block';
						
						// Get the repositioned overlay
						var overlay = document.querySelector('.page-main #cd-overlay');
						if (overlay) {
							overlay.style.display = 'block';
						}
						
						// Apply blur only to main content
						document.querySelectorAll('.page-main, .page-footer, .nav-sections, .breadcrumbs').forEach(function(el) {
							if (el) el.style.filter = 'blur(4px)';
						});
						
						// Force header elements to be visible
						document.querySelectorAll('.page-header, header.page-header, .cd-header-container').forEach(function(el) {
							if (el) {
								el.style.position = 'relative';
								el.style.zIndex = '1200';
								el.style.filter = 'none';
								el.style.opacity = '1';
								el.style.visibility = 'visible';
							}
						});
						
						// Focus search input
						setTimeout(function() {
							document.getElementById('cd-search-input').focus();
						}, 100);
					});
				}
			});
			
			// Also run on window load
			window.addEventListener('load', fixOverlayPosition);
		})();
	</script>

</div>